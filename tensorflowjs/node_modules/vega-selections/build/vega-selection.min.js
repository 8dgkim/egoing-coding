!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("vega-util"),require("vega-expression")):"function"==typeof define&&define.amd?define(["exports","vega-util","vega-expression"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).vega={},e.vega,e.vega)}(this,(function(e,t,n){"use strict";function r(e,t){return null==e||null==t?NaN:e<t?-1:e>t?1:e>=t?0:NaN}class i extends Set{constructor(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:u;if(super(),Object.defineProperties(this,{_intern:{value:new Map},_key:{value:t}}),null!=e)for(const t of e)this.add(t)}has(e){return super.has(function(e,t){let{_intern:n,_key:r}=e;const i=r(t);return n.has(i)?n.get(i):t}(this,e))}add(e){return super.add(function(e,t){let{_intern:n,_key:r}=e;const i=r(t);return n.has(i)?n.get(i):(n.set(i,t),t)}(this,e))}delete(e){return super.delete(function(e,t){let{_intern:n,_key:r}=e;const i=r(t);n.has(i)&&(t=n.get(i),n.delete(i));return t}(this,e))}}function u(e){return null!==e&&"object"==typeof e?e.valueOf():e}function o(e){return e instanceof i?e:new i(e)}const l="intersect",s="union",f="_vgsid_",a=t.field(f),c="index:unit";function d(e,n){for(var r,i,u=n.fields,o=n.values,l=u.length,s=0;s<l;++s)if((i=u[s]).getter=t.field.getter||t.field(i.field),r=i.getter(e),t.isDate(r)&&(r=t.toNumber(r)),t.isDate(o[s])&&(o[s]=t.toNumber(o[s])),t.isDate(o[s][0])&&(o[s]=o[s].map(t.toNumber)),"E"===i.type){if(t.isArray(o[s])?o[s].indexOf(r)<0:r!==o[s])return!1}else if("R"===i.type){if(!t.inrange(r,o[s]))return!1}else if("R-RE"===i.type){if(!t.inrange(r,o[s],!0,!1))return!1}else if("R-E"===i.type){if(!t.inrange(r,o[s],!1,!1))return!1}else if("R-LE"===i.type&&!t.inrange(r,o[s],!1,!0))return!1;return!0}const g=function(e){let t=e,n=e,i=e;function u(e,t){let r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,u=arguments.length>3&&void 0!==arguments[3]?arguments[3]:e.length;if(r<u){if(0!==n(t,t))return u;do{const n=r+u>>>1;i(e[n],t)<0?r=n+1:u=n}while(r<u)}return r}return 2!==e.length&&(t=(t,n)=>e(t)-n,n=r,i=(t,n)=>r(e(t),n)),{left:u,center:function(e,n){let r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:e.length;const o=u(e,n,r,i-1);return o>r&&t(e[o-1],n)>-t(e[o],n)?o-1:o},right:function(e,t){let r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,u=arguments.length>3&&void 0!==arguments[3]?arguments[3]:e.length;if(r<u){if(0!==n(t,t))return u;do{const n=r+u>>>1;i(e[n],t)<=0?r=n+1:u=n}while(r<u)}return r}}}(a),h=g.left,v=g.right;var p={["".concat(f,"_union")]:function(){const e=new i;for(var t=arguments.length,n=new Array(t),r=0;r<t;r++)n[r]=arguments[r];for(const t of n)for(const n of t)e.add(n);return e},["".concat(f,"_intersect")]:function(e){for(var t=arguments.length,n=new Array(t>1?t-1:0),r=1;r<t;r++)n[r-1]=arguments[r];e=new i(e),n=n.map(o);e:for(const t of e)for(const r of n)if(!r.has(t)){e.delete(t);continue e}return e},E_union:function(e,t){if(!e.length)return t;for(var n=0,r=t.length;n<r;++n)e.indexOf(t[n])<0&&e.push(t[n]);return e},E_intersect:function(e,t){return e.length?e.filter((e=>t.indexOf(e)>=0)):t},R_union:function(e,n){var r=t.toNumber(n[0]),i=t.toNumber(n[1]);return r>i&&(r=n[1],i=n[0]),e.length?(e[0]>r&&(e[0]=r),e[1]<i&&(e[1]=i),e):[r,i]},R_intersect:function(e,n){var r=t.toNumber(n[0]),i=t.toNumber(n[1]);return r>i&&(r=n[1],i=n[0]),e.length?i<e[0]||e[1]<r?[]:(e[0]<r&&(e[0]=r),e[1]>i&&(e[1]=i),e):[r,i]}};e.selectionIdTest=function(e,t,n){const r=this.context.data[e],i=r?r.values.value:[],u=r?r[c]&&r[c].value:void 0,o=n===l,s=a(t),f=h(i,s);if(f===i.length)return!1;if(a(i[f])!==s)return!1;if(u&&o){if(1===u.size)return!0;if(v(i,s)-f<u.size)return!1}return!0},e.selectionResolve=function(e,n,r,i){for(var u,o,l,c,d,g,h,v,y,_,m,b,x=this.context.data[e],O=x?x.values.value:[],N={},w={},R={},j=O.length,k=0;k<j;++k)if(c=(u=O[k]).unit,o=u.fields,l=u.values,o&&l){for(m=0,b=o.length;m<b;++m)d=o[m],v=(h=N[d.field]||(N[d.field]={}))[c]||(h[c]=[]),R[d.field]=y=d.type.charAt(0),_=p["".concat(y,"_union")],h[c]=_(v,t.array(l[m]));r&&(v=w[c]||(w[c]=[])).push(t.array(l).reduce(((e,t,n)=>(e[o[n].field]=t,e)),{}))}else d=f,g=a(u),(v=(h=N[d]||(N[d]={}))[c]||(h[c]=[])).push(g),r&&(v=w[c]||(w[c]=[])).push({[f]:g});if(n=n||s,N._vgsid_?N._vgsid_=p["".concat(f,"_").concat(n)](...Object.values(N._vgsid_)):Object.keys(N).forEach((e=>{N[e]=Object.keys(N[e]).map((t=>N[e][t])).reduce(((t,r)=>void 0===t?r:p["".concat(R[e],"_").concat(n)](t,r)))})),O=Object.keys(w),r&&O.length){N[i?"vlPoint":"vlMulti"]=n===s?{or:O.reduce(((e,t)=>(e.push(...w[t]),e)),[])}:{and:O.map((e=>({or:w[e]})))}}return N},e.selectionTest=function(e,t,n){for(var r,i,u,o,s,f=this.context.data[e],a=f?f.values.value:[],g=f?f[c]&&f[c].value:void 0,h=n===l,v=a.length,p=0;p<v;++p)if(r=a[p],g&&h){if(-1===(u=(i=i||{})[o=r.unit]||0))continue;if(s=d(t,r),i[o]=s?-1:++u,s&&1===g.size)return!0;if(!s&&u===g.get(o).count)return!1}else if(h^(s=d(t,r)))return s;return v&&h},e.selectionTuples=function(e,n){return e.map((e=>t.extend(n.fields?{values:n.fields.map((n=>(n.getter||(n.getter=t.field(n.field)))(e.datum)))}:{[f]:a(e.datum)},n)))},e.selectionVisitor=function(e,r,i,u){r[0].type!==n.Literal&&t.error("First argument to selection functions must be a string literal.");const o=r[0].value,s="unit",f="@unit",a=":"+o;(r.length>=2&&t.peek(r).value)!==l||t.hasOwnProperty(u,f)||(u["@unit"]=i.getData(o).indataRef(i,s)),t.hasOwnProperty(u,a)||(u[a]=i.getData(o).tuplesRef())},Object.defineProperty(e,"__esModule",{value:!0})}));
//# sourceMappingURL=vega-selection.min.js.map
