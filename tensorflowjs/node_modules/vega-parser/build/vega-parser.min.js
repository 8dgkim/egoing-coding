!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("vega-util"),require("vega-functions"),require("vega-event-selector"),require("vega-scale"),require("vega-dataflow")):"function"==typeof define&&define.amd?define(["exports","vega-util","vega-functions","vega-event-selector","vega-scale","vega-dataflow"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).vega={},e.vega,e.vega,e.vega,e.vega,e.vega)}(this,(function(e,t,n,i,a,r){"use strict";function s(e){return t.isObject(e)?e:{type:e||"pad"}}const l=e=>+e||0;function o(e){return t.isObject(e)?e.signal?e:{top:l(e.top),bottom:l(e.bottom),left:l(e.left),right:l(e.right)}:{top:n=l(e),bottom:n,left:n,right:n};var n}const u=e=>t.isObject(e)&&!t.isArray(e)?t.extend({},e):{value:e};function c(e,n,i,a){if(null!=i){return t.isObject(i)&&!t.isArray(i)||t.isArray(i)&&i.length&&t.isObject(i[0])?e.update[n]=i:e[a||"enter"][n]={value:i},1}return 0}function d(e,t,n){for(const n in t)c(e,n,t[n]);for(const t in n)c(e,t,n[t],"update")}function p(e,n,i){for(const a in n)i&&t.hasOwnProperty(i,a)||(e[a]=t.extend(e[a]||{},n[a]));return e}function f(e,t){return t&&(t.enter&&t.enter[e]||t.update&&t.update[e])}const g="mark",m="frame",h="scope",y="axis",b="axis-domain",x="axis-grid",k="axis-label",v="axis-tick",$="axis-title",S="legend",O="legend-entry",R="legend-label",j="legend-symbol",w="legend-title",z="title-text",D="title-subtitle";function V(e,t,n){e[t]=n&&n.signal?{signal:n.signal}:{value:n}}const P=e=>t.isString(e)?t.stringValue(e):e.signal?`(${e.signal})`:W(e);function E(e){if(null!=e.gradient)return function(e){const n=[e.start,e.stop,e.count].map((e=>null==e?null:t.stringValue(e)));for(;n.length&&null==t.peek(n);)n.pop();return n.unshift(P(e.gradient)),`gradient(${n.join(",")})`}(e);let n=e.signal?`(${e.signal})`:e.color?function(e){return e.c?_("hcl",e.h,e.c,e.l):e.h||e.s?_("hsl",e.h,e.s,e.l):e.l||e.a?_("lab",e.l,e.a,e.b):e.r||e.g||e.b?_("rgb",e.r,e.g,e.b):null}(e.color):null!=e.field?W(e.field):void 0!==e.value?t.stringValue(e.value):void 0;return null!=e.scale&&(n=function(e,t){const n=P(e.scale);null!=e.range?t=`lerp(_range(${n}), ${+e.range})`:(void 0!==t&&(t=`_scale(${n}, ${t})`),e.band&&(t=(t?t+"+":"")+`_bandwidth(${n})`+(1==+e.band?"":"*"+C(e.band)),e.extra&&(t=`(datum.extra ? _scale(${n}, datum.extra.value) : ${t})`)),null==t&&(t="0"));return t}(e,n)),void 0===n&&(n=null),null!=e.exponent&&(n=`pow(${n},${C(e.exponent)})`),null!=e.mult&&(n+=`*${C(e.mult)}`),null!=e.offset&&(n+=`+${C(e.offset)}`),e.round&&(n=`round(${n})`),n}const _=(e,t,n,i)=>`(${e}(${[t,n,i].map(E).join(",")})+'')`;function C(e){return t.isObject(e)?"("+E(e)+")":e}function W(e){return L(t.isObject(e)?e:{datum:e})}function L(e){let n,i,a;if(e.signal)n="datum",a=e.signal;else if(e.group||e.parent){for(i=Math.max(1,e.level||1),n="item";i-- >0;)n+=".mark.group";e.parent?(a=e.parent,n+=".datum"):a=e.group}else e.datum?(n="datum",a=e.datum):t.error("Invalid field reference: "+t.stringValue(e));return e.signal||(a=t.isString(a)?t.splitAccessPath(a).map(t.stringValue).join("]["):L(a)),n+"["+a+"]"}function F(e,n,i,a,r,s){const l={};(s=s||{}).encoders={$encode:l},e=function(e,n,i,a,r){const s={},l={};let o,u,c,d;for(u in u="lineBreak","text"!==n||null==r[u]||f(u,e)||V(s,u,r[u]),("legend"==i||String(i).startsWith("axis"))&&(i=null),d=i===m?r.group:i===g?t.extend({},r.mark,r[n]):null,d)c=f(u,e)||("fill"===u||"stroke"===u)&&(f("fill",e)||f("stroke",e)),c||V(s,u,d[u]);for(u in t.array(a).forEach((t=>{const n=r.style&&r.style[t];for(const t in n)f(t,e)||V(s,t,n[t])})),e=t.extend({},e),s)d=s[u],d.signal?(o=o||{})[u]=d:l[u]=d;return e.enter=t.extend(l,e.enter),o&&(e.update=t.extend(o,e.update)),e}(e,n,i,a,r.config);for(const t in e)l[t]=A(e[t],n,s,r);return s}function A(e,n,i,a){const r={},s={};for(const n in e)null!=e[n]&&(r[n]=T((l=e[n],t.isArray(l)?function(e){let n="";return e.forEach((e=>{const t=E(e);n+=e.test?`(${e.test})?${t}:`:t})),":"===t.peek(n)&&(n+="null"),n}(l):E(l)),a,i,s));var l;return{$expr:{marktype:n,channels:r},$fields:Object.keys(s),$output:Object.keys(e)}}function T(e,i,a,r){const s=n.parseExpression(e,i);return s.$fields.forEach((e=>r[e]=1)),t.extend(a,s.$params),s.$expr}const B=["value","update","init","react","bind"];function U(e,n){t.error(e+' for "outer" push: '+t.stringValue(n))}function M(e,t){const n=e.name;if("outer"===e.push)t.signals[n]||U("No prior signal definition",n),B.forEach((t=>{void 0!==e[t]&&U("Invalid property ",t)}));else{const i=t.addSignal(n,e.value);!1===e.react&&(i.react=!1),e.bind&&t.addBinding(n,e.bind)}}function q(e,t,n,i){this.id=-1,this.type=e,this.value=t,this.params=n,i&&(this.parent=i)}function H(e,t,n,i){return new q(e,t,n,i)}function I(e,t){return H("operator",e,t)}function X(e){const t={$ref:e.id};return e.id<0&&(e.refs=e.refs||[]).push(t),t}function Y(e,t){return t?{$field:e,$name:t}:{$field:e}}const N=Y("key");function G(e,t){return{$compare:e,$order:t}}function Q(e,t){return(e&&e.signal?"$"+e.signal:e||"")+(e&&t?"_":"")+(t&&t.signal?"$"+t.signal:t||"")}const J="scope",K="view";function Z(e){return e&&e.signal}function ee(e){if(Z(e))return!0;if(t.isObject(e))for(const t in e)if(ee(e[t]))return!0;return!1}function te(e,t){return null!=e?e:t}function ne(e){return e&&e.signal||e}const ie="timer";function ae(e,n){return(e.merge?re:e.stream?se:e.type?le:t.error("Invalid stream specification: "+t.stringValue(e)))(e,n)}function re(e,t){const n=oe({merge:e.merge.map((e=>ae(e,t)))},e,t);return t.addStream(n).id}function se(e,t){const n=oe({stream:ae(e.stream,t)},e,t);return t.addStream(n).id}function le(e,t){let n;var i;e.type===ie?(n=t.event(ie,e.throttle),e={between:e.between,filter:e.filter}):n=t.event((i=e.source)===J?K:i||K,e.type);const a=oe({stream:n},e,t);return 1===Object.keys(a).length?n:t.addStream(a).id}function oe(e,i,a){let r=i.between;return r&&(2!==r.length&&t.error('Stream "between" parameter must have 2 entries: '+t.stringValue(i)),e.between=[ae(r[0],a),ae(r[1],a)]),r=i.filter?[].concat(i.filter):[],(i.marktype||i.markname||i.markrole)&&r.push(function(e,t,n){const i="event.item";return i+(e&&"*"!==e?"&&"+i+".mark.marktype==='"+e+"'":"")+(n?"&&"+i+".mark.role==='"+n+"'":"")+(t?"&&"+i+".mark.name==='"+t+"'":"")}(i.marktype,i.markname,i.markrole)),i.source===J&&r.push("inScope(event.item)"),r.length&&(e.filter=n.parseExpression("("+r.join(")&&(")+")",a).$expr),null!=(r=i.throttle)&&(e.throttle=+r),null!=(r=i.debounce)&&(e.debounce=+r),i.consume&&(e.consume=!0),e}const ue={code:"_.$value",ast:{type:"Identifier",value:"value"}};function ce(e,a,r){const s=e.encode,l={target:r};let o=e.events,u=e.update,c=[];o||t.error("Signal update missing events specification."),t.isString(o)&&(o=i.parseSelector(o,a.isSubscope()?J:K)),o=t.array(o).filter((e=>e.signal||e.scale?(c.push(e),0):1)),c.length>1&&(c=[de(c)]),o.length&&c.push(o.length>1?{merge:o}:o[0]),null!=s&&(u&&t.error("Signal encode and update are mutually exclusive."),u="encode(item(),"+t.stringValue(s)+")"),l.update=t.isString(u)?n.parseExpression(u,a):null!=u.expr?n.parseExpression(u.expr,a):null!=u.value?u.value:null!=u.signal?{$expr:ue,$params:{$value:a.signalRef(u.signal)}}:t.error("Invalid signal update specification."),e.force&&(l.options={force:!0}),c.forEach((e=>a.addUpdate(t.extend(function(e,t){return{source:e.signal?t.signalRef(e.signal):e.scale?t.scaleRef(e.scale):ae(e,t)}}(e,a),l))))}function de(e){return{signal:"["+e.map((e=>e.scale?'scale("'+e.scale+'")':e.signal))+"]"}}function pe(e,i){const a=i.getSignal(e.name);let r=e.update;e.init&&(r?t.error("Signals can not include both init and update expressions."):(r=e.init,a.initonly=!0)),r&&(r=n.parseExpression(r,i),a.update=r.$expr,a.params=r.$params),e.on&&e.on.forEach((e=>ce(e,i,a.id)))}const fe=e=>(t,n,i)=>H(e,n,t||void 0,i),ge=fe("aggregate"),me=fe("axisticks"),he=fe("bound"),ye=fe("collect"),be=fe("compare"),xe=fe("datajoin"),ke=fe("encode"),ve=fe("expression"),$e=fe("facet"),Se=fe("field"),Oe=fe("key"),Re=fe("legendentries"),je=fe("load"),we=fe("mark"),ze=fe("multiextent"),De=fe("multivalues"),Ve=fe("overlap"),Pe=fe("params"),Ee=fe("prefacet"),_e=fe("projection"),Ce=fe("proxy"),We=fe("relay"),Le=fe("render"),Fe=fe("scale"),Ae=fe("sieve"),Te=fe("sortitems"),Be=fe("viewlayout"),Ue=fe("values");let Me=0;const qe={min:"min",max:"max",count:"sum"};function He(e,n){const i=n.getScale(e.name).params;let a;var r;for(a in i.domain=Ne(e.domain,e,n),null!=e.range&&(i.range=nt(e,n,i)),null!=e.interpolate&&function(e,t){t.interpolate=Ie(e.type||e),null!=e.gamma&&(t.interpolateGamma=Ie(e.gamma))}(e.interpolate,i),null!=e.nice&&(i.nice=(r=e.nice,t.isObject(r)?{interval:Ie(r.interval),step:Ie(r.step)}:Ie(r))),null!=e.bins&&(i.bins=function(e,n){return e.signal||t.isArray(e)?Xe(e,n):n.objectProperty(e)}(e.bins,n)),e)t.hasOwnProperty(i,a)||"name"===a||(i[a]=Ie(e[a],n))}function Ie(e,n){return t.isObject(e)?e.signal?n.signalRef(e.signal):t.error("Unsupported object: "+t.stringValue(e)):e}function Xe(e,t){return e.signal?t.signalRef(e.signal):e.map((e=>Ie(e,t)))}function Ye(e){t.error("Can not find data set: "+t.stringValue(e))}function Ne(e,n,i){if(e)return e.signal?i.signalRef(e.signal):(t.isArray(e)?Ge:e.fields?Je:Qe)(e,n,i);null==n.domainMin&&null==n.domainMax||t.error("No scale domain defined for domainMin/domainMax to override.")}function Ge(e,t,n){return e.map((e=>Ie(e,n)))}function Qe(e,t,n){const i=n.getData(e.data);return i||Ye(e.data),a.isDiscrete(t.type)?i.valuesRef(n,e.field,Ze(e.sort,!1)):a.isQuantile(t.type)?i.domainRef(n,e.field):i.extentRef(n,e.field)}function Je(e,n,i){const r=e.data,s=e.fields.reduce(((e,n)=>(n=t.isString(n)?{data:r,field:n}:t.isArray(n)||n.signal?function(e,n){const i="_:vega:_"+Me++,a=ye({});if(t.isArray(e))a.value={$ingest:e};else if(e.signal){const r="setdata("+t.stringValue(i)+","+e.signal+")";a.params.input=n.signalRef(r)}return n.addDataPipeline(i,[a,Ae({})]),{data:i,field:"data"}}(n,i):n,e.push(n),e)),[]);return(a.isDiscrete(n.type)?Ke:a.isQuantile(n.type)?et:tt)(e,i,s)}function Ke(e,t,n){const i=Ze(e.sort,!0);let a,r;const s=n.map((e=>{const n=t.getData(e.data);return n||Ye(e.data),n.countsRef(t,e.field,i)})),l={groupby:N,pulse:s};i&&(a=i.op||"count",r=i.field?Q(a,i.field):"count",l.ops=[qe[a]],l.fields=[t.fieldRef(r)],l.as=[r]),a=t.add(ge(l));const o=t.add(ye({pulse:X(a)}));return r=t.add(Ue({field:N,sort:t.sortRef(i),pulse:X(o)})),X(r)}function Ze(e,n){return e&&(e.field||e.op?e.field||"count"===e.op?n&&e.field&&e.op&&!qe[e.op]&&t.error("Multiple domain scales can not be sorted using "+e.op):t.error("No field provided for sort aggregate op: "+e.op):t.isObject(e)?e.field="key":e={field:"key"}),e}function et(e,t,n){const i=n.map((e=>{const n=t.getData(e.data);return n||Ye(e.data),n.domainRef(t,e.field)}));return X(t.add(De({values:i})))}function tt(e,t,n){const i=n.map((e=>{const n=t.getData(e.data);return n||Ye(e.data),n.extentRef(t,e.field)}));return X(t.add(ze({extents:i})))}function nt(e,n,i){const r=n.config.range;let s=e.range;if(s.signal)return n.signalRef(s.signal);if(t.isString(s)){if(r&&t.hasOwnProperty(r,s))return nt(e=t.extend({},e,{range:r[s]}),n,i);"width"===s?s=[0,{signal:"width"}]:"height"===s?s=a.isDiscrete(e.type)?[0,{signal:"height"}]:[{signal:"height"},0]:t.error("Unrecognized scale range value: "+t.stringValue(s))}else{if(s.scheme)return i.scheme=t.isArray(s.scheme)?Xe(s.scheme,n):Ie(s.scheme,n),s.extent&&(i.schemeExtent=Xe(s.extent,n)),void(s.count&&(i.schemeCount=Ie(s.count,n)));if(s.step)return void(i.rangeStep=Ie(s.step,n));if(a.isDiscrete(e.type)&&!t.isArray(s))return Ne(s,e,n);t.isArray(s)||t.error("Unsupported range type: "+t.stringValue(s))}return s.map((e=>(t.isArray(e)?Xe:Ie)(e,n)))}function it(e,n,i){return t.isArray(e)?e.map((e=>it(e,n,i))):t.isObject(e)?e.signal?i.signalRef(e.signal):"fit"===n?e:t.error("Unsupported parameter object: "+t.stringValue(e)):e}const at="top",rt="left",st="right",lt="bottom",ot="center",ut="index",ct="label",dt="perc",pt="value",ft="guide-label",gt="guide-title",mt="group-title",ht="group-subtitle",yt="symbol",bt="gradient",xt="discrete",kt="size",vt=[kt,"shape","fill","stroke","strokeWidth","strokeDash","opacity"],$t={name:1,style:1,interactive:1},St={value:0},Ot={value:1},Rt="group",jt="rect",wt="rule",zt="text";function Dt(e){return e.type=Rt,e.interactive=e.interactive||!1,e}function Vt(e,t){const n=(n,i)=>te(e[n],te(t[n],i));return n.isVertical=n=>"vertical"===te(e.direction,t.direction||(n?t.symbolDirection:t.gradientDirection)),n.gradientLength=()=>te(e.gradientLength,t.gradientLength||t.gradientWidth),n.gradientThickness=()=>te(e.gradientThickness,t.gradientThickness||t.gradientHeight),n.entryColumns=()=>te(e.columns,te(t.columns,+n.isVertical(!0))),n}function Pt(e,t){const n=t&&(t.update&&t.update[e]||t.enter&&t.enter[e]);return n&&n.signal?n:n?n.value:null}function Et(e,t,n){return`item.anchor === 'start' ? ${e} : item.anchor === 'end' ? ${t} : ${n}`}const _t=Et(t.stringValue(rt),t.stringValue(st),t.stringValue(ot));function Ct(e,n){return n?e?t.isObject(e)?Object.assign({},e,{offset:Ct(e.offset,n)}):{value:e,offset:n}:n:e}function Wt(e,t){return t?(e.name=t.name,e.style=t.style||e.style,e.interactive=!!t.interactive,e.encode=p(e.encode,t,$t)):e.interactive=!1,e}function Lt(e,n,i,a){const r=Vt(e,i),s=r.isVertical(),l=r.gradientThickness(),o=r.gradientLength();let c,p,f,g,m;s?(p=[0,1],f=[0,0],g=l,m=o):(p=[0,0],f=[1,0],g=o,m=l);const h={enter:c={opacity:St,x:St,y:St,width:u(g),height:u(m)},update:t.extend({},c,{opacity:Ot,fill:{gradient:n,start:p,stop:f}}),exit:{opacity:St}};return d(h,{stroke:r("gradientStrokeColor"),strokeWidth:r("gradientStrokeWidth")},{opacity:r("gradientOpacity")}),Wt({type:jt,role:"legend-gradient",encode:h},a)}function Ft(e,n,i,a,r){const s=Vt(e,i),l=s.isVertical(),o=s.gradientThickness(),c=s.gradientLength();let p,f,g,m,h="";l?(p="y",g="y2",f="x",m="width",h="1-"):(p="x",g="x2",f="y",m="height");const y={opacity:St,fill:{scale:n,field:pt}};y[p]={signal:h+"datum."+dt,mult:c},y[f]=St,y[g]={signal:h+"datum.perc2",mult:c},y[m]=u(o);const b={enter:y,update:t.extend({},y,{opacity:Ot}),exit:{opacity:St}};return d(b,{stroke:s("gradientStrokeColor"),strokeWidth:s("gradientStrokeWidth")},{opacity:s("gradientOpacity")}),Wt({type:jt,role:"legend-band",key:pt,from:r,encode:b},a)}function At(e,t,n,i){const a=Vt(e,t),r=a.isVertical(),s=u(a.gradientThickness()),l=a.gradientLength();let o,c,p,f,g=a("labelOverlap"),m="";const h={enter:o={opacity:St},update:c={opacity:Ot,text:{field:ct}},exit:{opacity:St}};return d(h,{fill:a("labelColor"),fillOpacity:a("labelOpacity"),font:a("labelFont"),fontSize:a("labelFontSize"),fontStyle:a("labelFontStyle"),fontWeight:a("labelFontWeight"),limit:te(e.labelLimit,t.gradientLabelLimit)}),r?(o.align={value:"left"},o.baseline=c.baseline={signal:'datum.perc<=0?"bottom":datum.perc>=1?"top":"middle"'},p="y",f="x",m="1-"):(o.align=c.align={signal:'datum.perc<=0?"left":datum.perc>=1?"right":"center"'},o.baseline={value:"top"},p="x",f="y"),o[p]=c[p]={signal:m+"datum."+dt,mult:l},o[f]=c[f]=s,s.offset=te(e.labelOffset,t.gradientLabelOffset)||0,g=g?{separation:a("labelSeparation"),method:g,order:"datum.index"}:void 0,Wt({type:zt,role:R,style:ft,key:pt,from:i,encode:h,overlap:g},n)}function Tt(e,t,n,i,a){const r=Vt(e,t),s=n.entries,l=!(!s||!s.interactive),o=s?s.name:void 0,c=r("clipHeight"),f=r("symbolOffset"),g={data:"value"},m=`(${a}) ? datum.offset : datum.size`,y=c?u(c):{field:kt},b="datum.index",x=`max(1, ${a})`;let k,v,$,S,O;y.mult=.5,k={enter:v={opacity:St,x:{signal:m,mult:.5,offset:f},y:y},update:$={opacity:Ot,x:v.x,y:v.y},exit:{opacity:St}};let w=null,z=null;e.fill||(w=t.symbolBaseFillColor,z=t.symbolBaseStrokeColor),d(k,{fill:r("symbolFillColor",w),shape:r("symbolType"),size:r("symbolSize"),stroke:r("symbolStrokeColor",z),strokeDash:r("symbolDash"),strokeDashOffset:r("symbolDashOffset"),strokeWidth:r("symbolStrokeWidth")},{opacity:r("symbolOpacity")}),vt.forEach((t=>{e[t]&&($[t]=v[t]={scale:e[t],field:pt})}));const D=Wt({type:"symbol",role:j,key:pt,from:g,clip:!!c||void 0,encode:k},n.symbols),V=u(f);V.offset=r("labelOffset"),k={enter:v={opacity:St,x:{signal:m,offset:V},y:y},update:$={opacity:Ot,text:{field:ct},x:v.x,y:v.y},exit:{opacity:St}},d(k,{align:r("labelAlign"),baseline:r("labelBaseline"),fill:r("labelColor"),fillOpacity:r("labelOpacity"),font:r("labelFont"),fontSize:r("labelFontSize"),fontStyle:r("labelFontStyle"),fontWeight:r("labelFontWeight"),limit:r("labelLimit")});const P=Wt({type:zt,role:R,style:ft,key:pt,from:g,encode:k},n.labels);return k={enter:{noBound:{value:!c},width:St,height:c?u(c):St,opacity:St},exit:{opacity:St},update:$={opacity:Ot,row:{signal:null},column:{signal:null}}},r.isVertical(!0)?(S=`ceil(item.mark.items.length / ${x})`,$.row.signal=`${b}%${S}`,$.column.signal=`floor(${b} / ${S})`,O={field:["row",b]}):($.row.signal=`floor(${b} / ${x})`,$.column.signal=`${b} % ${x}`,O={field:b}),$.column.signal=`(${a})?${$.column.signal}:${b}`,Dt({role:h,from:i={facet:{data:i,name:"value",groupby:ut}},encode:p(k,s,$t),marks:[D,P],name:o,interactive:l,sort:O})}const Bt='item.orient === "left"',Ut='item.orient === "right"',Mt=`(${Bt} || ${Ut})`,qt=`datum.vgrad && ${Mt}`,Ht=Et('"top"','"bottom"','"middle"'),It=`datum.vgrad && ${Ut} ? (${Et('"right"','"left"','"center"')}) : (${Mt} && !(datum.vgrad && ${Bt})) ? "left" : ${_t}`,Xt=`item._anchor || (${Mt} ? "middle" : "start")`,Yt=`${qt} ? (${Bt} ? -90 : 90) : 0`,Nt=`${Mt} ? (datum.vgrad ? (${Ut} ? "bottom" : "top") : ${Ht}) : "top"`;function Gt(e,n){let i;return t.isObject(e)&&(e.signal?i=e.signal:e.path?i="pathShape("+Qt(e.path)+")":e.sphere&&(i="geoShape("+Qt(e.sphere)+', {type: "Sphere"})')),i?n.signalRef(i):!!e}function Qt(e){return t.isObject(e)&&e.signal?e.signal:t.stringValue(e)}function Jt(e){const t=e.role||"";return t.indexOf("axis")&&t.indexOf("legend")&&t.indexOf("title")?e.type===Rt?h:t||g:t}function Kt(e){return{marktype:e.type,name:e.name||void 0,role:e.role||Jt(e),zindex:+e.zindex||void 0,aria:e.aria,description:e.description}}function Zt(e,t){return e&&e.signal?t.signalRef(e.signal):!1!==e}function en(e,n){const i=r.definition(e.type);i||t.error("Unrecognized transform type: "+t.stringValue(e.type));const a=H(i.type.toLowerCase(),null,tn(i,e,n));return e.signal&&n.addSignal(e.signal,n.proxy(a)),a.metadata=i.metadata||{},a}function tn(e,t,n){const i={},a=e.params.length;for(let r=0;r<a;++r){const a=e.params[r];i[a.name]=nn(a,t,n)}return i}function nn(e,n,i){const a=e.type,r=n[e.name];return"index"===a?function(e,n,i){t.isString(n.from)||t.error('Lookup "from" parameter must be a string literal.');return i.getData(n.from).lookupRef(i,n.key)}(0,n,i):void 0!==r?"param"===a?function(e,n,i){const a=n[e.name];return e.array?(t.isArray(a)||t.error("Expected an array of sub-parameters. Instead: "+t.stringValue(a)),a.map((t=>rn(e,t,i)))):rn(e,a,i)}(e,n,i):"projection"===a?i.projectionRef(n[e.name]):e.array&&!Z(r)?r.map((t=>an(e,t,i))):an(e,r,i):void(e.required&&t.error("Missing required "+t.stringValue(n.type)+" parameter: "+t.stringValue(e.name)))}function an(e,i,a){const r=e.type;if(Z(i))return un(r)?t.error("Expression references can not be signals."):cn(r)?a.fieldRef(i):dn(r)?a.compareRef(i):a.signalRef(i.signal);{const t=e.expr||cn(r);return t&&sn(i)?a.exprRef(i.expr,i.as):t&&ln(i)?Y(i.field,i.as):un(r)?n.parseExpression(i,a):on(r)?X(a.getData(i).values):cn(r)?Y(i):dn(r)?a.compareRef(i):i}}function rn(e,n,i){const a=e.params.length;let r;for(let t=0;t<a;++t){r=e.params[t];for(const e in r.key)if(r.key[e]!==n[e]){r=null;break}if(r)break}r||t.error("Unsupported parameter: "+t.stringValue(n));const s=t.extend(tn(r,n,i),r.key);return X(i.add(Pe(s)))}const sn=e=>e&&e.expr,ln=e=>e&&e.field,on=e=>"data"===e,un=e=>"expr"===e,cn=e=>"field"===e,dn=e=>"compare"===e;function pn(e,t){return e.$ref?e:e.data&&e.data.$ref?e.data:X(t.getData(e.data).output)}function fn(e,t,n,i,a){this.scope=e,this.input=t,this.output=n,this.values=i,this.aggregate=a,this.index={}}function gn(e){return t.isString(e)?e:null}function mn(e,t,n){const i=Q(n.op,n.field);let a;if(t.ops){for(let e=0,n=t.as.length;e<n;++e)if(t.as[e]===i)return}else t.ops=["count"],t.fields=[null],t.as=["count"];n.op&&(t.ops.push((a=n.op.signal)?e.signalRef(a):n.op),t.fields.push(e.fieldRef(n.field)),t.as.push(i))}function hn(e,n,i,a,r,s,l){const o=n[i]||(n[i]={}),u=function(e){return t.isObject(e)?("descending"===e.order?"-":"+")+Q(e.op,e.field):""}(s);let c,d,p=gn(r);if(null!=p&&(e=n.scope,p+=u?"|"+u:"",c=o[p]),!c){const t=s?{field:N,pulse:n.countsRef(e,r,s)}:{field:e.fieldRef(r),pulse:X(n.output)};u&&(t.sort=e.sortRef(s)),d=e.add(H(a,void 0,t)),l&&(n.index[r]=d),c=X(d),null!=p&&(o[p]=c)}return c}function yn(e,t,i){const a=e.remove,r=e.insert,s=e.toggle,l=e.modify,o=e.values,u=t.add(I()),c="if("+e.trigger+',modify("'+i+'",'+[r,a,s,l,o].map((e=>null==e?"null":e)).join(",")+"),0)",d=n.parseExpression(c,t);u.update=d.$expr,u.params=d.$params}function bn(e,n){const i=Jt(e),a=e.type===Rt,r=e.from&&e.from.facet,s=e.overlap;let l,o,u,c,d,p,f,y=e.layout||i===h||i===m;const b=i===g||y||r,x=function(e,n,i){let a,r,s,l,o;return e?(a=e.facet)&&(n||t.error("Only group marks can be faceted."),null!=a.field?l=o=pn(a,i):(e.data?o=X(i.getData(e.data).aggregate):(s=en(t.extend({type:"aggregate",groupby:t.array(a.groupby)},a.aggregate),i),s.params.key=i.keyRef(a.groupby),s.params.pulse=pn(a,i),l=o=X(i.add(s))),r=i.keyRef(a.groupby,!0))):l=X(i.add(ye(null,[{}]))),l||(l=pn(e,i)),{key:r,pulse:l,parent:o}}(e.from,a,n);o=n.add(xe({key:x.key||(e.key?Y(e.key):void 0),pulse:x.pulse,clean:!a}));const k=X(o);o=u=n.add(ye({pulse:k})),o=n.add(we({markdef:Kt(e),interactive:Zt(e.interactive,n),clip:Gt(e.clip,n),context:{$context:!0},groups:n.lookup(),parent:n.signals.parent?n.signalRef("parent"):null,index:n.markpath(),pulse:X(o)}));const v=X(o);o=c=n.add(ke(F(e.encode,e.type,i,e.style,n,{mod:!1,pulse:v}))),o.params.parent=n.encode(),e.transform&&e.transform.forEach((e=>{const i=en(e,n),a=i.metadata;(a.generates||a.changes)&&t.error("Mark transforms should not generate new data."),a.nomod||(c.params.mod=!0),i.params.pulse=X(o),n.add(o=i)})),e.sort&&(o=n.add(Te({sort:n.compareRef(e.sort),pulse:X(o)})));const $=X(o);(r||y)&&(y=n.add(Be({layout:n.objectProperty(e.layout),legends:n.legends,mark:v,pulse:$})),p=X(y));const S=n.add(he({mark:v,pulse:p||$}));f=X(S),a&&(b&&(l=n.operators,l.pop(),y&&l.pop()),n.pushState($,p||f,k),r?function(e,n,i){const a=e.from.facet,r=a.name,s=pn(a,n);let l;a.name||t.error("Facet must have a name: "+t.stringValue(a)),a.data||t.error("Facet must reference a data set: "+t.stringValue(a)),a.field?l=n.add(Ee({field:n.fieldRef(a.field),pulse:s})):a.groupby?l=n.add($e({key:n.keyRef(a.groupby),group:X(n.proxy(i.parent)),pulse:s})):t.error("Facet must specify groupby or field: "+t.stringValue(a));const o=n.fork(),u=o.add(ye()),c=o.add(Ae({pulse:X(u)}));o.addData(r,new fn(o,u,u,c)),o.addSignal("parent",null),l.params.subflow={$subflow:o.parse(e).toRuntime()}}(e,n,x):b?function(e,t,n){const i=t.add(Ee({pulse:n.pulse})),a=t.fork();a.add(Ae()),a.addSignal("parent",null),i.params.subflow={$subflow:a.parse(e).toRuntime()}}(e,n,x):n.parse(e),n.popState(),b&&(y&&l.push(y),l.push(S))),s&&(f=function(e,t,n){const i=e.method,a=e.bound,r=e.separation,s={separation:Z(r)?n.signalRef(r.signal):r,method:Z(i)?n.signalRef(i.signal):i,pulse:t};e.order&&(s.sort=n.compareRef({field:e.order}));if(a){const e=a.tolerance;s.boundTolerance=Z(e)?n.signalRef(e.signal):+e,s.boundScale=n.scaleRef(a.scale),s.boundOrient=a.orient}return X(n.add(Ve(s)))}(s,f,n));const O=n.add(Le({pulse:f})),R=n.add(Ae({pulse:X(O)},void 0,n.parent()));null!=e.name&&(d=e.name,n.addData(d,new fn(n,u,O,R)),e.on&&e.on.forEach((e=>{(e.insert||e.remove||e.toggle)&&t.error("Marks only support modify triggers."),yn(e,n,d)})))}function xn(e,i){const r=i.config.legend,s=e.encode||{},l=Vt(e,r),o=s.legend||{},u=o.name||void 0,c=o.interactive,f=o.style,g={};let m,h,y,b=0;vt.forEach((t=>e[t]?(g[t]=e[t],b=b||e[t]):0)),b||t.error("Missing valid scale for legend.");const x=function(e,t){let n=e.type||yt;e.type||1!==function(e){return vt.reduce(((t,n)=>t+(e[n]?1:0)),0)}(e)||!e.fill&&!e.stroke||(n=a.isContinuous(t)?bt:a.isDiscretizing(t)?xt:yt);return n!==bt?n:a.isDiscretizing(t)?xt:bt}(e,i.scaleType(b)),k={title:null!=e.title,scales:g,type:x,vgrad:"symbol"!==x&&l.isVertical()},v=X(i.add(ye(null,[k]))),$=X(i.add(Re(h={type:x,scale:i.scaleRef(b),count:i.objectProperty(l("tickCount")),limit:i.property(l("symbolLimit")),values:i.objectProperty(e.values),minstep:i.property(e.tickMinStep),formatType:i.property(e.formatType),formatSpecifier:i.property(e.format)})));return x===bt?(y=[Lt(e,b,r,s.gradient),At(e,r,s.labels,$)],h.count=h.count||i.signalRef(`max(2,2*floor((${ne(l.gradientLength())})/100))`)):x===xt?y=[Ft(e,b,r,s.gradient,$),At(e,r,s.labels,$)]:(m=function(e,t){const n=Vt(e,t);return{align:n("gridAlign"),columns:n.entryColumns(),center:{row:!0,column:!1},padding:{row:n("rowPadding"),column:n("columnPadding")}}}(e,r),y=[Tt(e,r,s,$,ne(m.columns))],h.size=function(e,t,i){const a=ne(vn("size",e,i)),r=ne(vn("strokeWidth",e,i)),s=ne(function(e,t,n){return Pt("fontSize",e)||function(e,t,n){const i=t.config.style[n];return i&&i[e]}("fontSize",t,n)}(i[1].encode,t,ft));return n.parseExpression(`max(ceil(sqrt(${a})+${r}),${s})`,t)}(e,i,y[0].marks)),y=[Dt({role:O,from:v,encode:{enter:{x:{value:0},y:{value:0}}},marks:y,layout:m,interactive:c})],k.title&&y.push(function(e,t,n,i){const a=Vt(e,t),r={enter:{opacity:St},update:{opacity:Ot,x:{field:{group:"padding"}},y:{field:{group:"padding"}}},exit:{opacity:St}};return d(r,{orient:a("titleOrient"),_anchor:a("titleAnchor"),anchor:{signal:Xt},angle:{signal:Yt},align:{signal:It},baseline:{signal:Nt},text:e.title,fill:a("titleColor"),fillOpacity:a("titleOpacity"),font:a("titleFont"),fontSize:a("titleFontSize"),fontStyle:a("titleFontStyle"),fontWeight:a("titleFontWeight"),limit:a("titleLimit"),lineHeight:a("titleLineHeight")},{align:a("titleAlign"),baseline:a("titleBaseline")}),Wt({type:zt,role:w,style:gt,from:i,encode:r},n)}(e,r,s.title,v)),bn(Dt({role:S,from:v,encode:p(kn(l,e,r),o,$t),marks:y,aria:l("aria"),description:l("description"),zindex:l("zindex"),name:u,interactive:c,style:f}),i)}function kn(e,t,n){const i={enter:{},update:{}};return d(i,{orient:e("orient"),offset:e("offset"),padding:e("padding"),titlePadding:e("titlePadding"),cornerRadius:e("cornerRadius"),fill:e("fillColor"),stroke:e("strokeColor"),strokeWidth:n.strokeWidth,strokeDash:n.strokeDash,x:e("legendX"),y:e("legendY"),format:t.format,formatType:t.formatType}),i}function vn(e,t,n){return t[e]?`scale("${t[e]}",datum)`:Pt(e,n[0].encode)}fn.fromEntries=function(e,t){const n=t.length,i=t[n-1],a=t[n-2];let r=t[0],s=null,l=1;for(r&&"load"===r.type&&(r=t[1]),e.add(t[0]);l<n;++l)t[l].params.pulse=X(t[l-1]),e.add(t[l]),"aggregate"===t[l].type&&(s=t[l]);return new fn(e,r,a,i,s)},fn.prototype={countsRef(e,t,n){const i=this,a=i.counts||(i.counts={}),r=gn(t);let s,l,o;return null!=r&&(e=i.scope,s=a[r]),s?n&&n.field&&mn(e,s.agg.params,n):(o={groupby:e.fieldRef(t,"key"),pulse:X(i.output)},n&&n.field&&mn(e,o,n),l=e.add(ge(o)),s=e.add(ye({pulse:X(l)})),s={agg:l,ref:X(s)},null!=r&&(a[r]=s)),s.ref},tuplesRef(){return X(this.values)},extentRef(e,t){return hn(e,this,"extent","extent",t,!1)},domainRef(e,t){return hn(e,this,"domain","values",t,!1)},valuesRef(e,t,n){return hn(e,this,"vals","values",t,n||!0)},lookupRef(e,t){return hn(e,this,"lookup","tupleindex",t,!1)},indataRef(e,t){return hn(e,this,"indata","tupleindex",t,!0,!0)}};function $n(e,n){const i=Vt(e=t.isString(e)?{text:e}:e,n.config.title),a=e.encode||{},r=a.group||{},s=r.name||void 0,l=r.interactive,o=r.style,u=[],c=X(n.add(ye(null,[{}])));return u.push(function(e,t,n,i){const a={value:0},r=e.text,s={enter:{opacity:a},update:{opacity:{value:1}},exit:{opacity:a}};return d(s,{text:r,align:{signal:"item.mark.group.align"},angle:{signal:"item.mark.group.angle"},limit:{signal:"item.mark.group.limit"},baseline:"top",dx:t("dx"),dy:t("dy"),fill:t("color"),font:t("font"),fontSize:t("fontSize"),fontStyle:t("fontStyle"),fontWeight:t("fontWeight"),lineHeight:t("lineHeight")},{align:t("align"),angle:t("angle"),baseline:t("baseline")}),Wt({type:zt,role:z,style:mt,from:i,encode:s},n)}(e,i,function(e){const n=e.encode;return n&&n.title||t.extend({name:e.name,interactive:e.interactive,style:e.style},n)}(e),c)),e.subtitle&&u.push(function(e,t,n,i){const a={value:0},r=e.subtitle,s={enter:{opacity:a},update:{opacity:{value:1}},exit:{opacity:a}};return d(s,{text:r,align:{signal:"item.mark.group.align"},angle:{signal:"item.mark.group.angle"},limit:{signal:"item.mark.group.limit"},baseline:"top",dx:t("dx"),dy:t("dy"),fill:t("subtitleColor"),font:t("subtitleFont"),fontSize:t("subtitleFontSize"),fontStyle:t("subtitleFontStyle"),fontWeight:t("subtitleFontWeight"),lineHeight:t("subtitleLineHeight")},{align:t("align"),angle:t("angle"),baseline:t("baseline")}),Wt({type:zt,role:D,style:ht,from:i,encode:s},n)}(e,i,a.subtitle,c)),bn(Dt({role:"title",from:c,encode:Sn(i,r),marks:u,aria:i("aria"),description:i("description"),zindex:i("zindex"),name:s,interactive:l,style:o}),n)}function Sn(e,t){const n={enter:{},update:{}};return d(n,{orient:e("orient"),anchor:e("anchor"),align:{signal:_t},angle:{signal:'item.orient==="left"?-90:item.orient==="right"?90:0'},limit:e("limit"),frame:e("frame"),offset:e("offset")||0,padding:e("subtitlePadding")}),p(n,t,$t)}function On(e,n){const i=[];e.transform&&e.transform.forEach((e=>{i.push(en(e,n))})),e.on&&e.on.forEach((t=>{yn(t,n,e.name)})),n.addDataPipeline(e.name,function(e,n,i){const a=[];let r,s,l,o,u,c=null,d=!1,p=!1;e.values?Z(e.values)||ee(e.format)?(a.push(jn(n,e)),a.push(c=Rn())):a.push(c=Rn({$ingest:e.values,$format:e.format})):e.url?ee(e.url)||ee(e.format)?(a.push(jn(n,e)),a.push(c=Rn())):a.push(c=Rn({$request:e.url,$format:e.format})):e.source&&(c=r=t.array(e.source).map((e=>X(n.getData(e).output))),a.push(null));for(s=0,l=i.length;s<l;++s)o=i[s],u=o.metadata,c||u.source||a.push(c=Rn()),a.push(o),u.generates&&(p=!0),u.modifies&&!p&&(d=!0),u.source?c=o:u.changes&&(c=null);r&&(l=r.length-1,a[0]=We({derive:d,pulse:l?r:r[0]}),(d||l)&&a.splice(1,0,Rn()));c||a.push(Rn());return a.push(Ae({})),a}(e,n,i))}function Rn(e){const t=ye({},e);return t.metadata={source:!0},t}function jn(e,t){return je({url:t.url?e.property(t.url):void 0,async:t.async?e.property(t.async):void 0,values:t.values?e.property(t.values):void 0,format:e.objectProperty(t.format)})}const wn=e=>e===lt||e===at,zn=(e,t,n)=>Z(e)?Cn(e.signal,t,n):e===rt||e===at?t:n,Dn=(e,t,n)=>Z(e)?En(e.signal,t,n):wn(e)?t:n,Vn=(e,t,n)=>Z(e)?_n(e.signal,t,n):wn(e)?n:t,Pn=(e,t,n)=>Z(e)?Wn(e.signal,t,n):e===at?{value:t}:{value:n},En=(e,t,n)=>Fn(`${e} === 'top' || ${e} === 'bottom'`,t,n),_n=(e,t,n)=>Fn(`${e} !== 'top' && ${e} !== 'bottom'`,t,n),Cn=(e,t,n)=>Tn(`${e} === 'left' || ${e} === 'top'`,t,n),Wn=(e,t,n)=>Tn(`${e} === 'top'`,t,n),Ln=(e,t,n)=>Tn(`${e} === 'right'`,t,n),Fn=(e,n,i)=>(n=null!=n?u(n):n,i=null!=i?u(i):i,An(n)&&An(i)?{signal:`${e} ? (${n=n?n.signal||t.stringValue(n.value):null}) : (${i=i?i.signal||t.stringValue(i.value):null})`}:[t.extend({test:e},n)].concat(i||[])),An=e=>null==e||1===Object.keys(e).length,Tn=(e,t,n)=>({signal:`${e} ? (${Bn(t)}) : (${Bn(n)})`}),Bn=e=>Z(e)?e.signal:null==e?null:t.stringValue(e),Un=(e,t)=>{const n=e.signal;return n&&n.endsWith("(null)")?{signal:n.slice(0,-6)+t.signal}:e};function Mn(e,n,i,a){let r;if(n&&t.hasOwnProperty(n,e))return n[e];if(t.hasOwnProperty(i,e))return i[e];if(e.startsWith("title")){switch(e){case"titleColor":r="fill";break;case"titleFont":case"titleFontSize":case"titleFontWeight":r=e[5].toLowerCase()+e.slice(6)}return a["guide-title"][r]}if(e.startsWith("label")){switch(e){case"labelColor":r="fill";break;case"labelFont":case"labelFontSize":r=e[5].toLowerCase()+e.slice(6)}return a["guide-label"][r]}return null}function qn(e){const t={};for(const n of e)if(n)for(const e in n)t[e]=1;return Object.keys(t)}function Hn(e,t){return{scale:e.scale,range:t}}function In(e,n,i,a,r){const s=Vt(e,n),l=e.orient,o=e.gridScale,u=zn(l,1,-1),c=function(e,n){if(1===n);else if(t.isObject(e)){let i=e=t.extend({},e);for(;null!=i.mult;){if(!t.isObject(i.mult))return i.mult=Z(n)?{signal:`(${i.mult}) * (${n.signal})`}:i.mult*n,e;i=i.mult=t.extend({},i.mult)}i.mult=n}else e=Z(n)?{signal:`(${n.signal}) * (${e||0})`}:n*(e||0);return e}(e.offset,u);let p,f,g;const m={enter:p={opacity:St},update:g={opacity:Ot},exit:f={opacity:St}};d(m,{stroke:s("gridColor"),strokeCap:s("gridCap"),strokeDash:s("gridDash"),strokeDashOffset:s("gridDashOffset"),strokeOpacity:s("gridOpacity"),strokeWidth:s("gridWidth")});const h={scale:e.scale,field:pt,band:r.band,extra:r.extra,offset:r.offset,round:s("tickRound")},y=Dn(l,{signal:"height"},{signal:"width"}),b=o?{scale:o,range:0,mult:u,offset:c}:{value:0,offset:c},k=o?{scale:o,range:1,mult:u,offset:c}:t.extend(y,{mult:u,offset:c});return p.x=g.x=Dn(l,h,b),p.y=g.y=Vn(l,h,b),p.x2=g.x2=Vn(l,k),p.y2=g.y2=Dn(l,k),f.x=Dn(l,h),f.y=Vn(l,h),Wt({type:wt,role:x,key:pt,from:a,encode:m},i)}function Xn(e,t,n,i,a){return{signal:'flush(range("'+e+'"), scale("'+e+'", datum.value), '+t+","+n+","+i+","+a+")"}}function Yn(e,t,n,i,a,r){const s=Vt(e,t),l=e.orient,o=e.scale,c=zn(l,-1,1),p=ne(s("labelFlush")),f=ne(s("labelFlushOffset")),g=s("labelAlign"),m=s("labelBaseline");let h,y=0===p||!!p;const b=u(a);b.mult=c,b.offset=u(s("labelPadding")||0),b.offset.mult=c;const x={scale:o,field:pt,band:.5,offset:Ct(r.offset,s("labelOffset"))},v=Dn(l,y?Xn(o,p,'"left"','"right"','"center"'):{value:"center"},((e,t,n)=>Z(e)?Ln(e.signal,t,n):e===st?{value:t}:{value:n})(l,"left","right")),$=Dn(l,Pn(l,"bottom","top"),y?Xn(o,p,'"top"','"bottom"','"middle"'):{value:"middle"}),S=Xn(o,p,`-(${f})`,f,0);y=y&&f;const O={opacity:St,x:Dn(l,x,b),y:Vn(l,x,b)},R={enter:O,update:h={opacity:Ot,text:{field:ct},x:O.x,y:O.y,align:v,baseline:$},exit:{opacity:St,x:O.x,y:O.y}};d(R,{dx:!g&&y?Dn(l,S):null,dy:!m&&y?Vn(l,S):null}),d(R,{angle:s("labelAngle"),fill:s("labelColor"),fillOpacity:s("labelOpacity"),font:s("labelFont"),fontSize:s("labelFontSize"),fontWeight:s("labelFontWeight"),fontStyle:s("labelFontStyle"),limit:s("labelLimit"),lineHeight:s("labelLineHeight")},{align:g,baseline:m});const j=s("labelBound");let w=s("labelOverlap");return w=w||j?{separation:s("labelSeparation"),method:w,order:"datum.index",bound:j?{scale:o,orient:l,tolerance:j}:null}:void 0,h.align!==v&&(h.align=Un(h.align,v)),h.baseline!==$&&(h.baseline=Un(h.baseline,$)),Wt({type:zt,role:k,style:ft,key:pt,from:i,encode:R,overlap:w},n)}function Nn(e,n,i,a){const r=Vt(e,n),s=e.orient,l=zn(s,-1,1);let o,c;const p={enter:o={opacity:St,anchor:u(r("titleAnchor",null)),align:{signal:_t}},update:c=t.extend({},o,{opacity:Ot,text:u(e.title)}),exit:{opacity:St}},g={signal:`lerp(range("${e.scale}"), ${Et(0,1,.5)})`};return c.x=Dn(s,g),c.y=Vn(s,g),o.angle=Dn(s,St,((e,t)=>0===t?0:Z(e)?{signal:`(${e.signal}) * ${t}`}:{value:e*t})(l,90)),o.baseline=Dn(s,Pn(s,lt,at),{value:lt}),c.angle=o.angle,c.baseline=o.baseline,d(p,{fill:r("titleColor"),fillOpacity:r("titleOpacity"),font:r("titleFont"),fontSize:r("titleFontSize"),fontStyle:r("titleFontStyle"),fontWeight:r("titleFontWeight"),limit:r("titleLimit"),lineHeight:r("titleLineHeight")},{align:r("titleAlign"),angle:r("titleAngle"),baseline:r("titleBaseline")}),function(e,t,n,i){const a=(e,t)=>null!=e?(n.update[t]=Un(u(e),n.update[t]),!1):!f(t,i),r=a(e("titleX"),"x"),s=a(e("titleY"),"y");n.enter.auto=s===r?u(s):Dn(t,u(s),u(r))}(r,s,p,i),p.update.align=Un(p.update.align,o.align),p.update.angle=Un(p.update.angle,o.angle),p.update.baseline=Un(p.update.baseline,o.baseline),Wt({type:zt,role:$,style:gt,from:a,encode:p},i)}function Gn(e,n){const i=function(e,n){var i,a,r,s,l,o,u,c,d=n.config,p=d.style,f=d.axis,g="band"===n.scaleType(e.scale)&&d.axisBand,m=e.orient;if(Z(m)){const e=qn([d.axisX,d.axisY]),t=qn([d.axisTop,d.axisBottom,d.axisLeft,d.axisRight]);for(r of(i={},e))i[r]=Dn(m,Mn(r,d.axisX,f,p),Mn(r,d.axisY,f,p));for(r of(a={},t))a[r]=(s=m.signal,l=Mn(r,d.axisTop,f,p),o=Mn(r,d.axisBottom,f,p),u=Mn(r,d.axisLeft,f,p),c=Mn(r,d.axisRight,f,p),{signal:(null!=u?`${s} === 'left' ? (${Bn(u)}) : `:"")+(null!=o?`${s} === 'bottom' ? (${Bn(o)}) : `:"")+(null!=c?`${s} === 'right' ? (${Bn(c)}) : `:"")+(null!=l?`${s} === 'top' ? (${Bn(l)}) : `:"")+"(null)"})}else i=m===at||m===lt?d.axisX:d.axisY,a=d["axis"+m[0].toUpperCase()+m.slice(1)];return i||a||g?t.extend({},f,i,a,g):f}(e,n),a=e.encode||{},r=a.axis||{},s=r.name||void 0,l=r.interactive,o=r.style,c=Vt(e,i),f=function(e){const n=e("tickBand");let i,a,r=e("tickOffset");return n?n.signal?(i={signal:`(${n.signal}) === 'extent' ? 1 : 0.5`},a={signal:`(${n.signal}) === 'extent'`},t.isObject(r)||(r={signal:`(${n.signal}) === 'extent' ? 0 : ${r}`})):"extent"===n?(i=1,a=!0,r=0):(i=.5,a=!1):(i=e("bandPosition"),a=e("tickExtra")),{extra:a,band:i,offset:r}}(c),g={scale:e.scale,ticks:!!c("ticks"),labels:!!c("labels"),grid:!!c("grid"),domain:!!c("domain"),title:null!=e.title},m=X(n.add(ye({},[g]))),h=X(n.add(me({scale:n.scaleRef(e.scale),extra:n.property(f.extra),count:n.objectProperty(e.tickCount),values:n.objectProperty(e.values),minstep:n.property(e.tickMinStep),formatType:n.property(e.formatType),formatSpecifier:n.property(e.format)}))),x=[];let k;return g.grid&&x.push(In(e,i,a.grid,h,f)),g.ticks&&(k=c("tickSize"),x.push(function(e,t,n,i,a,r){const s=Vt(e,t),l=e.orient,o=zn(l,-1,1);let c,p,f;const g={enter:c={opacity:St},update:f={opacity:Ot},exit:p={opacity:St}};d(g,{stroke:s("tickColor"),strokeCap:s("tickCap"),strokeDash:s("tickDash"),strokeDashOffset:s("tickDashOffset"),strokeOpacity:s("tickOpacity"),strokeWidth:s("tickWidth")});const m=u(a);m.mult=o;const h={scale:e.scale,field:pt,band:r.band,extra:r.extra,offset:r.offset,round:s("tickRound")};return f.y=c.y=Dn(l,St,h),f.y2=c.y2=Dn(l,m),p.x=Dn(l,h),f.x=c.x=Vn(l,St,h),f.x2=c.x2=Vn(l,m),p.y=Vn(l,h),Wt({type:wt,role:v,key:pt,from:i,encode:g},n)}(e,i,a.ticks,h,k,f))),g.labels&&(k=g.ticks?k:0,x.push(Yn(e,i,a.labels,h,k,f))),g.domain&&x.push(function(e,t,n,i){const a=Vt(e,t),r=e.orient;let s,l;const o={enter:s={opacity:St},update:l={opacity:Ot},exit:{opacity:St}};d(o,{stroke:a("domainColor"),strokeCap:a("domainCap"),strokeDash:a("domainDash"),strokeDashOffset:a("domainDashOffset"),strokeWidth:a("domainWidth"),strokeOpacity:a("domainOpacity")});const u=Hn(e,0),c=Hn(e,1);return s.x=l.x=Dn(r,u,St),s.x2=l.x2=Dn(r,c),s.y=l.y=Vn(r,u,St),s.y2=l.y2=Vn(r,c),Wt({type:wt,role:b,from:i,encode:o},n)}(e,i,a.domain,m)),g.title&&x.push(Nn(e,i,a.title,m)),bn(Dt({role:y,from:m,encode:p(Qn(c,e),r,$t),marks:x,aria:c("aria"),description:c("description"),zindex:c("zindex"),name:s,interactive:l,style:o}),n)}function Qn(e,t){const n={enter:{},update:{}};return d(n,{orient:e("orient"),offset:e("offset")||0,position:te(t.position,0),titlePadding:e("titlePadding"),minExtent:e("minExtent"),maxExtent:e("maxExtent"),range:{signal:`abs(span(range("${t.scale}")))`},translate:e("translate"),format:t.format,formatType:t.formatType}),n}function Jn(e,n,i){const r=t.array(e.signals),s=t.array(e.scales);return i||r.forEach((e=>M(e,n))),t.array(e.projections).forEach((e=>function(e,t){const n=t.config.projection||{},i={};for(const n in e)"name"!==n&&(i[n]=it(e[n],n,t));for(const e in n)null==i[e]&&(i[e]=it(n[e],e,t));t.addProjection(e.name,i)}(e,n))),s.forEach((e=>function(e,n){const i=e.type||"linear";a.isValidScaleType(i)||t.error("Unrecognized scale type: "+t.stringValue(i)),n.addScale(e.name,{type:i,domain:void 0})}(e,n))),t.array(e.data).forEach((e=>On(e,n))),s.forEach((e=>He(e,n))),(i||r).forEach((e=>pe(e,n))),t.array(e.axes).forEach((e=>Gn(e,n))),t.array(e.marks).forEach((e=>bn(e,n))),t.array(e.legends).forEach((e=>xn(e,n))),e.title&&$n(e.title,n),n.parseLambdas(),n}function Kn(e,n){const i=n.config,a=X(n.root=n.add(I())),r=function(e,n){const i=t=>te(e[t],n[t]),a=[Zn("background",i("background")),Zn("autosize",s(i("autosize"))),Zn("padding",o(i("padding"))),Zn("width",i("width")||0),Zn("height",i("height")||0)],r=a.reduce(((e,t)=>(e[t.name]=t,e)),{}),l={};return t.array(e.signals).forEach((e=>{t.hasOwnProperty(r,e.name)?e=t.extend(r[e.name],e):a.push(e),l[e.name]=e})),t.array(n.signals).forEach((e=>{t.hasOwnProperty(l,e.name)||t.hasOwnProperty(r,e.name)||a.push(e)})),a}(e,i);r.forEach((e=>M(e,n))),n.description=e.description||i.description,n.eventConfig=i.events,n.legends=n.objectProperty(i.legend&&i.legend.layout),n.locale=i.locale;const l=n.add(ye()),u=n.add(ke(F((e=>p({enter:{x:{value:0},y:{value:0}},update:{width:{signal:"width"},height:{signal:"height"}}},e))(e.encode),Rt,m,e.style,n,{pulse:X(l)}))),c=n.add(Be({layout:n.objectProperty(e.layout),legends:n.legends,autosize:n.signalRef("autosize"),mark:a,pulse:X(u)}));n.operators.pop(),n.pushState(X(u),X(c),null),Jn(e,n,r),n.operators.push(c);let d=n.add(he({mark:a,pulse:X(c)}));return d=n.add(Le({pulse:X(d)})),d=n.add(Ae({pulse:X(d)})),n.addData("root",new fn(n,l,l,d)),n}function Zn(e,t){return t&&t.signal?{name:e,update:t.signal}:{name:e,value:t}}function ei(e,t){this.config=e||{},this.options=t||{},this.bindings=[],this.field={},this.signals={},this.lambdas={},this.scales={},this.events={},this.data={},this.streams=[],this.updates=[],this.operators=[],this.eventConfig=null,this.locale=null,this._id=0,this._subid=0,this._nextsub=[0],this._parent=[],this._encode=[],this._lookup=[],this._markpath=[]}function ti(e){this.config=e.config,this.options=e.options,this.legends=e.legends,this.field=Object.create(e.field),this.signals=Object.create(e.signals),this.lambdas=Object.create(e.lambdas),this.scales=Object.create(e.scales),this.events=Object.create(e.events),this.data=Object.create(e.data),this.streams=[],this.updates=[],this.operators=[],this._id=0,this._subid=++e._nextsub[0],this._nextsub=e._nextsub,this._parent=e._parent.slice(),this._encode=e._encode.slice(),this._lookup=e._lookup.slice(),this._markpath=e._markpath}function ni(e){return(t.isArray(e)?ii:ai)(e)}function ii(e){const n=e.length;let i="[";for(let a=0;a<n;++a){const n=e[a];i+=(a>0?",":"")+(t.isObject(n)?n.signal||ni(n):t.stringValue(n))}return i+"]"}function ai(e){let n,i,a="{",r=0;for(n in e)i=e[n],a+=(++r>1?",":"")+t.stringValue(n)+":"+(t.isObject(i)?i.signal||ni(i):t.stringValue(i));return a+"}"}function ri(){const e="sans-serif",t="#4c78a8",n="#000",i="#888",a="#ddd";return{description:"Vega visualization",padding:0,autosize:"pad",background:null,events:{defaults:{allow:["wheel"]}},group:null,mark:null,arc:{fill:t},area:{fill:t},image:null,line:{stroke:t,strokeWidth:2},path:{stroke:t},rect:{fill:t},rule:{stroke:n},shape:{stroke:t},symbol:{fill:t,size:64},text:{fill:n,font:e,fontSize:11},trail:{fill:t,size:2},style:{"guide-label":{fill:n,font:e,fontSize:10},"guide-title":{fill:n,font:e,fontSize:11,fontWeight:"bold"},"group-title":{fill:n,font:e,fontSize:13,fontWeight:"bold"},"group-subtitle":{fill:n,font:e,fontSize:12},point:{size:30,strokeWidth:2,shape:"circle"},circle:{size:30,strokeWidth:2},square:{size:30,strokeWidth:2,shape:"square"},cell:{fill:"transparent",stroke:a}},title:{orient:"top",anchor:"middle",offset:4,subtitlePadding:3},axis:{minExtent:0,maxExtent:200,bandPosition:.5,domain:!0,domainWidth:1,domainColor:i,grid:!1,gridWidth:1,gridColor:a,labels:!0,labelAngle:0,labelLimit:180,labelOffset:0,labelPadding:2,ticks:!0,tickColor:i,tickOffset:0,tickRound:!0,tickSize:5,tickWidth:1,titlePadding:4},axisBand:{tickOffset:-.5},projection:{type:"mercator"},legend:{orient:"right",padding:0,gridAlign:"each",columnPadding:10,rowPadding:2,symbolDirection:"vertical",gradientDirection:"vertical",gradientLength:200,gradientThickness:16,gradientStrokeColor:a,gradientStrokeWidth:0,gradientLabelOffset:2,labelAlign:"left",labelBaseline:"middle",labelLimit:160,labelOffset:4,labelOverlap:!0,symbolLimit:30,symbolType:"circle",symbolSize:100,symbolOffset:0,symbolStrokeWidth:1.5,symbolBaseFillColor:"transparent",symbolBaseStrokeColor:i,titleLimit:180,titleOrient:"top",titlePadding:5,layout:{offset:18,direction:"horizontal",left:{direction:"vertical"},right:{direction:"vertical"}}},range:{category:{scheme:"tableau10"},ordinal:{scheme:"blues"},heatmap:{scheme:"yellowgreenblue"},ramp:{scheme:"blues"},diverging:{scheme:"blueorange",extent:[1,0]},symbol:["circle","square","triangle-up","cross","diamond","triangle-right","triangle-down","triangle-left"]}}}ei.prototype=ti.prototype={parse(e){return Jn(e,this)},fork(){return new ti(this)},isSubscope(){return this._subid>0},toRuntime(){return this.finish(),{description:this.description,operators:this.operators,streams:this.streams,updates:this.updates,bindings:this.bindings,eventConfig:this.eventConfig,locale:this.locale}},id(){return(this._subid?this._subid+":":0)+this._id++},add(e){return this.operators.push(e),e.id=this.id(),e.refs&&(e.refs.forEach((t=>{t.$ref=e.id})),e.refs=null),e},proxy(e){const t=e instanceof q?X(e):e;return this.add(Ce({value:t}))},addStream(e){return this.streams.push(e),e.id=this.id(),e},addUpdate(e){return this.updates.push(e),e},finish(){let e,t;for(e in this.root&&(this.root.root=!0),this.signals)this.signals[e].signal=e;for(e in this.scales)this.scales[e].scale=e;function n(e,t,n){let i,a;e&&(i=e.data||(e.data={}),a=i[t]||(i[t]=[]),a.push(n))}for(e in this.data){t=this.data[e],n(t.input,e,"input"),n(t.output,e,"output"),n(t.values,e,"values");for(const i in t.index)n(t.index[i],e,"index:"+i)}return this},pushState(e,t,n){this._encode.push(X(this.add(Ae({pulse:e})))),this._parent.push(t),this._lookup.push(n?X(this.proxy(n)):null),this._markpath.push(-1)},popState(){this._encode.pop(),this._parent.pop(),this._lookup.pop(),this._markpath.pop()},parent(){return t.peek(this._parent)},encode(){return t.peek(this._encode)},lookup(){return t.peek(this._lookup)},markpath(){const e=this._markpath;return++e[e.length-1]},fieldRef(e,n){if(t.isString(e))return Y(e,n);e.signal||t.error("Unsupported field reference: "+t.stringValue(e));const i=e.signal;let a=this.field[i];if(!a){const e={name:this.signalRef(i)};n&&(e.as=n),this.field[i]=a=X(this.add(Se(e)))}return a},compareRef(e){let n=!1;const i=e=>Z(e)?(n=!0,this.signalRef(e.signal)):function(e){return e&&e.expr}(e)?(n=!0,this.exprRef(e.expr)):e,a=t.array(e.field).map(i),r=t.array(e.order).map(i);return n?X(this.add(be({fields:a,orders:r}))):G(a,r)},keyRef(e,n){let i=!1;const a=this.signals;return e=t.array(e).map((e=>Z(e)?(i=!0,X(a[e.signal])):e)),i?X(this.add(Oe({fields:e,flat:n}))):function(e,t){const n={$key:e};return t&&(n.$flat=!0),n}(e,n)},sortRef(e){if(!e)return e;const t=Q(e.op,e.field),n=e.order||"ascending";return n.signal?X(this.add(be({fields:t,orders:this.signalRef(n.signal)}))):G(t,n)},event(e,t){const n=e+":"+t;if(!this.events[n]){const i=this.id();this.streams.push({id:i,source:e,type:t}),this.events[n]=i}return this.events[n]},hasOwnSignal(e){return t.hasOwnProperty(this.signals,e)},addSignal(e,n){this.hasOwnSignal(e)&&t.error("Duplicate signal name: "+t.stringValue(e));const i=n instanceof q?n:this.add(I(n));return this.signals[e]=i},getSignal(e){return this.signals[e]||t.error("Unrecognized signal name: "+t.stringValue(e)),this.signals[e]},signalRef(e){return this.signals[e]?X(this.signals[e]):(t.hasOwnProperty(this.lambdas,e)||(this.lambdas[e]=this.add(I(null))),X(this.lambdas[e]))},parseLambdas(){const e=Object.keys(this.lambdas);for(let t=0,i=e.length;t<i;++t){const i=e[t],a=n.parseExpression(i,this),r=this.lambdas[i];r.params=a.$params,r.update=a.$expr}},property(e){return e&&e.signal?this.signalRef(e.signal):e},objectProperty(e){return e&&t.isObject(e)?this.signalRef(e.signal||ni(e)):e},exprRef(e,t){const i={expr:n.parseExpression(e,this)};return t&&(i.expr.$name=t),X(this.add(ve(i)))},addBinding(e,n){this.bindings||t.error("Nested signals do not support binding: "+t.stringValue(e)),this.bindings.push(t.extend({signal:e},n))},addScaleProj(e,n){t.hasOwnProperty(this.scales,e)&&t.error("Duplicate scale or projection name: "+t.stringValue(e)),this.scales[e]=this.add(n)},addScale(e,t){this.addScaleProj(e,Fe(t))},addProjection(e,t){this.addScaleProj(e,_e(t))},getScale(e){return this.scales[e]||t.error("Unrecognized scale name: "+t.stringValue(e)),this.scales[e]},scaleRef(e){return X(this.getScale(e))},scaleType(e){return this.getScale(e).params.type},projectionRef(e){return this.scaleRef(e)},projectionType(e){return this.scaleType(e)},addData(e,n){return t.hasOwnProperty(this.data,e)&&t.error("Duplicate data set name: "+t.stringValue(e)),this.data[e]=n},getData(e){return this.data[e]||t.error("Undefined data set name: "+t.stringValue(e)),this.data[e]},addDataPipeline(e,n){return t.hasOwnProperty(this.data,e)&&t.error("Duplicate data set name: "+t.stringValue(e)),this.addData(e,fn.fromEntries(this,n))}},e.AxisDomainRole=b,e.AxisGridRole=x,e.AxisLabelRole=k,e.AxisRole=y,e.AxisTickRole=v,e.AxisTitleRole=$,e.DataScope=fn,e.FrameRole=m,e.LegendEntryRole=O,e.LegendLabelRole=R,e.LegendRole=S,e.LegendSymbolRole=j,e.LegendTitleRole=w,e.MarkRole=g,e.Scope=ei,e.ScopeRole=h,e.config=ri,e.parse=function(e,n,i){return t.isObject(e)||t.error("Input Vega specification must be an object."),Kn(e,new ei(n=t.mergeConfig(ri(),n,e.config),i)).toRuntime()},e.signal=M,e.signalUpdates=pe,e.stream=ae,Object.defineProperty(e,"__esModule",{value:!0})}));
//# sourceMappingURL=vega-parser.min.js.map
